plugins {
    id("com.gradleup.shadow") version "9.3.0"
    id("io.micronaut.application") version "4.6.1"
    id("io.micronaut.test-resources") version "4.6.1"
    id("io.micronaut.aot") version "4.6.1"
    id("com.coditory.manifest") version "1.1.0"
}

version = "2.0.0-SNAPSHOT"
group = "ca.team1310.ravenbrain"

repositories {
    mavenCentral()
}

dependencies {
    annotationProcessor("io.micronaut:micronaut-http-validation")
    annotationProcessor("io.micronaut.security:micronaut-security-annotations")
    annotationProcessor("io.micronaut.serde:micronaut-serde-processor")
    annotationProcessor("io.micronaut.servlet:micronaut-servlet-processor")
    annotationProcessor 'org.projectlombok:lombok:1.18.36'
    testAnnotationProcessor 'org.projectlombok:lombok:1.18.36'
    implementation("io.micronaut.flyway:micronaut-flyway")

    annotationProcessor 'io.micronaut.data:micronaut-data-processor'
    implementation 'io.micronaut.data:micronaut-data-jdbc'

    implementation("io.micronaut.security:micronaut-security-jwt")
    implementation("io.micronaut.serde:micronaut-serde-jackson")
    implementation("io.micronaut.sql:micronaut-jdbc-hikari")
    compileOnly("org.projectlombok:lombok:1.18.36")
    compileOnly("io.micronaut:micronaut-http-client")
    runtimeOnly("ch.qos.logback:logback-classic")
    runtimeOnly("com.mysql:mysql-connector-j")
    runtimeOnly("org.flywaydb:flyway-mysql")
    runtimeOnly("org.yaml:snakeyaml")
    testImplementation("io.micronaut:micronaut-http-client")
    testCompileOnly 'org.projectlombok:lombok:1.18.36'
    testAnnotationProcessor("io.micronaut.serde:micronaut-serde-processor")
    aotPlugins platform("io.micronaut.platform:micronaut-platform")
    aotPlugins("io.micronaut.security:micronaut-security-aot")
}


application {
    mainClass = "ca.team1310.ravenbrain.Application"
}
java {
    sourceCompatibility = JavaVersion.toVersion("25")
    targetCompatibility = JavaVersion.toVersion("25")
}


graalvmNative.toolchainDetection = false

micronaut {
    runtime("tomcat")
    testRuntime("junit5")
    processing {
        incremental(true)
        annotations("ca.team1310.ravenbrain.*")
    }
    testResources {
        additionalModules.add("jdbc-mysql")
    }
    aot {
        // Please review carefully the optimizations enabled below
        // Check https://micronaut-projects.github.io/micronaut-aot/latest/guide/ for more details
        optimizeServiceLoading = false
        convertYamlToJava = false
        precomputeOperations = true
        cacheEnvironment = true
        optimizeClassLoading = true
        deduceEnvironment = true
        optimizeNetty = true
        replaceLogbackXml = true
        configurationProperties.put("micronaut.security.jwks.enabled", "false")
    }
}


tasks.named("dockerfileNative") {
    jdkVersion = "25"
}


manifest {
    buildAttributes = false
    implementationAttributes = true
    scmAttributes = false
    attributes = [
            "Implementation-Title": "Runnymede Robotics Team 1310 Raven Brain",
            "Build-Time"          : Instant.now().toString().substring(0, 19).replace("T", " ") + " UTC"
    ]
}
distributions {
    eb {
        contents {
            into('lib') {
                from shadowJar
            }
            into('') {
                from 'aws'
            }
            rename 'raven-brain-(.*).jar', 'raven-brain.jar'
        }
    }
}
tasks.register('createElasticbeanstalkDist', Copy) {
    from clean
    from ebDistZip
    destinationDir file('build/distributions')
    rename { String fileName ->
        fileName.replace("-$project.version", "")
    }
}
tasks.register('clearCdsClasslist') {
    doFirst {
        File classlist = file("build/test-resources/cds/cds.classlist")
        if (classlist.exists()) {
            println "Applying workaround to clear cds.classlist"
            classlist.delete()
        }
    }
}

// Ensure it runs before any other task
tasks.configureEach { task ->
    if (task.name != 'clearCdsClasslist') {
        task.dependsOn 'clearCdsClasslist'
    }
}